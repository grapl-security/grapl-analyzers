from typing import Any

from grapl_analyzerlib.analyzer import Analyzer, OneOrMany
from grapl_analyzerlib.execution import ExecutionHit
from grapl_analyzerlib.prelude import ProcessQuery, FileQuery, Not, ProcessView


# Detects exploitation attempt of privilege escalation vulnerability via SetupComplete.cmd
# and PartnerSetupComplete.cmd decribed in CVE-2019-1378
class ExploitingCVE_2019_1378(Analyzer):

    def get_queries(self) -> OneOrMany[ProcessQuery]:
        # Search for parents of cmd.exe,
        # where the parent process references SetupComplete or PartnerSetupComplete
        # And the parent is *not* executing from specific Windows directories
        return (
            ProcessQuery()
            .with_children(
                ProcessQuery()
                .with_bin_file(
                    FileQuery()
                    .with_file_path(ends_with="cmd.exe")
                )
                .with_arguments(contains=r"C:\Windows\Setup\Scripts\SetupComplete.cmd")
                .with_arguments(contains=r"C:\Windows\Setup\Scripts\PartnerSetupComplete.cmd")

            )
            .with_bin_file(
                FileQuery()
                .with_file_path(
                    contains=[
                        Not(r'C:\Windows\System32\\*'),
                        Not(r'C:\Windows\SysWOW64\\*'),
                        Not(r'C:\Windows\WinSxS\\*'),
                        Not(r'C:\Windows\Setup\\*'),
                    ]
                )
            )
        )

    def on_response(self, response: ProcessView, output: Any):
        output.send(
            ExecutionHit(
                analyzer_name="Exploiting SetupComplete.cmd CVE-2019-1378",
                node_view=response,
                risk_score=50,
            )
        )
